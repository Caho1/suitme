<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suitme API 测试工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        heading: ['Space Grotesk', 'sans-serif'],
                        body: ['DM Sans', 'sans-serif']
                    },
                    colors: {
                        primary: '#2563EB',
                        secondary: '#3B82F6',
                        cta: '#F97316',
                        bg: '#F8FAFC',
                        text: '#1E293B',
                        border: '#E2E8F0'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
        }
        h1, h2, h3, button {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* 减少动画，遵循 UX 最佳实践 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Bento Grid 自定义样式 */
        .bento-card {
            background: white;
            border: 1px solid #E2E8F0;
            transition: border-color 200ms, box-shadow 200ms;
        }

        .bento-card:hover {
            border-color: #2563EB;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .bento-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(12, 1fr);
        }

        @media (max-width: 768px) {
            .bento-grid > * {
                grid-column: span 12 !important;
            }
        }
    </style>
</head>
<body class="bg-bg min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white border-b border-border sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-text">Suitme API</h1>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-500">测试工具</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- API 配置区 -->
        <div class="bento-card rounded-xl p-6 mb-6">
            <h2 class="text-lg font-semibold text-text mb-4">API 配置</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Base URL</label>
                    <input type="text" id="baseUrl" value="http://43.139.129.10:8000"
                           class="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Token</label>
                    <input type="text" id="apiToken" value="" placeholder="输入你的 API Token"
                           class="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
        </div>

        <!-- Bento Grid 布局 -->
        <div class="bento-grid mb-6">
            <!-- 创建模特卡片 (大卡片) -->
            <div class="bento-card rounded-xl p-6 cursor-pointer" style="grid-column: span 8;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-text">创建模特</h2>
                    <span class="text-xs px-2 py-1 bg-primary/10 text-primary rounded-full">POST /models/default</span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">用户 ID</label>
                        <input type="text" id="default-user_id" value="user-123"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">性别</label>
                        <select id="default-gender" class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="女">女</option>
                            <option value="男">男</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">身高 (cm)</label>
                        <input type="number" id="default-height" value="165"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">体重 (kg)</label>
                        <input type="number" id="default-weight" value="55"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">年龄</label>
                        <input type="number" id="default-age" value="25"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">肤色</label>
                        <input type="text" id="default-skin_color" value="浅小麦"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">身材类型</label>
                        <input type="text" id="default-body_type" value="标准"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">图片比例</label>
                        <select id="default-size" class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="4:3" selected>4:3</option>
                            <option value="1:1">1:1</option>
                            <option value="2:3">2:3</option>
                            <option value="16:9">16:9</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">用户照片</label>
                    <input type="file" id="default-image" accept="image/*" class="hidden" onchange="handleImageSelect(this)">
                    <button type="button" onclick="document.getElementById('default-image').click()"
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        选择图片
                    </button>
                    <span id="selected-file-name" class="ml-3 text-sm text-gray-500">未选择文件</span>
                    <div id="image-preview-container" class="mt-3 hidden">
                        <img id="image-preview" class="h-24 rounded-lg border border-border" alt="预览">
                    </div>
                </div>

                <button onclick="createDefault()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                    创建模特
                </button>
            </div>

            <!-- 编辑模特卡片 (小卡片) -->
            <div class="bento-card rounded-xl p-6 cursor-pointer" style="grid-column: span 4;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-text">编辑模特</h2>
                    <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">POST /edit</span>
                </div>

                <div class="space-y-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">用户 ID</label>
                        <input type="text" id="edit-user_id" value="user-123"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">基础模特 Task ID</label>
                        <input type="text" id="edit-task_id" placeholder="task_01KC8E..."
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">编辑指令</label>
                        <textarea id="edit-instructions" rows="3" class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">将发型改为短发</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">图片比例</label>
                        <select id="edit-size" class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="4:3" selected>4:3</option>
                            <option value="1:1">1:1</option>
                            <option value="16:9">16:9</option>
                        </select>
                    </div>
                </div>

                <button onclick="editModel()" class="w-full bg-green-600 text-white py-2.5 rounded-lg hover:bg-green-700 transition-colors font-medium text-sm">
                    编辑模特
                </button>
            </div>

            <!-- 查询任务卡片 (小卡片) -->
            <div class="bento-card rounded-xl p-6 cursor-pointer" style="grid-column: span 4;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-text">查询任务</h2>
                    <span class="text-xs px-2 py-1 bg-orange-100 text-orange-700 rounded-full">GET /tasks</span>
                </div>

                <div class="space-y-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Task ID</label>
                        <input type="text" id="query-task_id" placeholder="task_abc123def"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>

                <div class="flex gap-2 mb-3">
                    <button onclick="queryTask()" class="flex-1 bg-orange-500 text-white py-2.5 rounded-lg hover:bg-orange-600 transition-colors font-medium text-sm">
                        查询一次
                    </button>
                </div>

                <div class="flex gap-2">
                    <button onclick="startPolling()" id="poll-btn" class="flex-1 bg-secondary text-white py-2.5 rounded-lg hover:bg-secondary/90 transition-colors font-medium text-sm">
                        开始轮询
                    </button>
                    <button onclick="stopPolling()" id="stop-poll-btn" class="flex-1 bg-red-500 text-white py-2.5 rounded-lg hover:bg-red-600 transition-colors font-medium text-sm hidden">
                        停止轮询
                    </button>
                </div>
                <div id="poll-status" class="mt-2 text-xs text-gray-500 hidden"></div>
            </div>

            <!-- 穿搭生成卡片 (大卡片) -->
            <div class="bento-card rounded-xl p-6 cursor-pointer" style="grid-column: span 8;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-text">穿搭生成</h2>
                    <span class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded-full">POST /models/outfit</span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">用户 ID</label>
                        <input type="text" id="outfit-user_id" value="user-123"
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">基础模特 Task ID</label>
                        <input type="text" id="outfit-task_id" placeholder="task_01KC8E..."
                               class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">角度</label>
                        <select id="outfit-angle" class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="front">正面 (front)</option>
                            <option value="side">侧面 (side)</option>
                            <option value="back">背面 (back)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">图片比例</label>
                        <select id="outfit-size" class="w-full px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="4:3" selected>4:3</option>
                            <option value="1:1">1:1</option>
                            <option value="2:3">2:3</option>
                            <option value="16:9">16:9</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">服装图片 (支持多选，最多5张)</label>
                    <input type="file" id="outfit-image-input" accept="image/*" multiple class="hidden" onchange="handleOutfitImageSelect(this)">
                    <button type="button" onclick="document.getElementById('outfit-image-input').click()"
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        选择图片
                    </button>
                    <span id="outfit-selected-count" class="ml-3 text-sm text-gray-500">已选择 3 张图片</span>
                    <div id="outfit-preview-container" class="flex gap-2 flex-wrap mt-3"></div>
                </div>

                <button onclick="createOutfit()" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                    生成穿搭
                </button>
            </div>
        </div>

        <!-- 响应结果区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- JSON 响应 -->
            <div class="bento-card rounded-xl p-6">
                <h3 class="text-lg font-semibold text-text mb-3">响应结果</h3>
                <pre id="response" class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-auto max-h-96 text-xs font-mono">等待请求...</pre>
            </div>

            <!-- 生成的图片 -->
            <div id="image-container" class="bento-card rounded-xl p-6 hidden">
                <h3 class="text-lg font-semibold text-text mb-3">生成的图片</h3>
                <img id="result-image" class="w-full rounded-lg mb-4 border border-border" alt="生成结果">
                <div id="image-url-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">图片 URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="image-url" readonly class="flex-1 px-3 py-2 border border-border rounded-lg bg-gray-50 text-xs">
                        <button onclick="copyUrl()" class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm">
                            复制
                        </button>
                        <a id="image-link" href="#" target="_blank" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            打开
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 存储选择的图片 Base64
        let selectedImageBase64 = null;

        // 图片选择处理
        function handleImageSelect(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('selected-file-name').textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImageBase64 = e.target.result;
                    document.getElementById('image-preview').src = selectedImageBase64;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // 存储选择的服装图片 URL 列表
        let selectedOutfitImages = [
            'https://suitme.oss-cn-shenzhen.aliyuncs.com/photos/20251223220514234804_0969aca497cce618cd63e0a96aa028d0.jpg',
            'https://suitme.oss-cn-shenzhen.aliyuncs.com/photos/20251223220514878969_e9cbe7972f8a3cd19f20fc5de96e1522.jpg',
            'https://suitme.oss-cn-shenzhen.aliyuncs.com/photos/20251223220515365730_870e2826fa35428a9d49220712fa5d89.png'
        ];

        // 页面加载时显示默认图片预览
        document.addEventListener('DOMContentLoaded', function() {
            updateOutfitPreview();
        });

        function updateOutfitPreview() {
            const previewContainer = document.getElementById('outfit-preview-container');
            previewContainer.innerHTML = '';
            previewContainer.classList.remove('hidden');
            document.getElementById('outfit-selected-count').textContent = `已选择 ${selectedOutfitImages.length} 张图片`;

            selectedOutfitImages.forEach((url, index) => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'h-20 rounded-lg border border-border';
                img.alt = `图片 ${index + 1}`;
                img.title = url;
                previewContainer.appendChild(img);
            });
        }

        function handleOutfitImageSelect(input) {
            const files = input.files;
            if (files.length > 0) {
                if (files.length > 5) {
                    alert('最多只能选择5张图片');
                    return;
                }
                document.getElementById('outfit-selected-count').textContent = `已选择 ${files.length} 个文件`;

                const previewContainer = document.getElementById('outfit-preview-container');
                previewContainer.innerHTML = '';
                previewContainer.classList.remove('hidden');

                selectedOutfitImages = [];

                Array.from(files).forEach((file) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedOutfitImages.push(e.target.result);

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'h-20 rounded-lg border border-border';
                        img.alt = file.name;
                        img.title = file.name;
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // 显示响应结果
        function showResponse(data) {
            document.getElementById('response').textContent = JSON.stringify(data, null, 2);
            const imageContainer = document.getElementById('image-container');
            const urlContainer = document.getElementById('image-url-container');
            const resultImage = document.getElementById('result-image');
            const imageUrl = document.getElementById('image-url');
            const imageLink = document.getElementById('image-link');

            const base64 = data.data?.image?.image_base64;
            const url = data.data?.image?.image_url;

            if (base64 || url) {
                imageContainer.classList.remove('hidden');
                resultImage.src = base64 || url;

                if (url) {
                    urlContainer.classList.remove('hidden');
                    imageUrl.value = url;
                    imageLink.href = url;
                } else {
                    urlContainer.classList.add('hidden');
                }
            } else {
                imageContainer.classList.add('hidden');
            }

            // 自动填充 task_id
            const taskId = data.data?.task_id;
            if (taskId) {
                document.getElementById('query-task_id').value = taskId;
                const status = data.data?.status;
                const taskType = data.data?.type;
                if (status === 'submitted' && !taskType) {
                    document.getElementById('edit-task_id').value = taskId;
                    document.getElementById('outfit-task_id').value = taskId;
                }
            }
        }

        function copyUrl() {
            const url = document.getElementById('image-url').value;
            navigator.clipboard.writeText(url).then(() => {
                alert('URL 已复制到剪贴板');
            });
        }

        function getHeaders() {
            const token = document.getElementById('apiToken').value;
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // API 调用函数
        async function createDefault() {
            const baseUrl = document.getElementById('baseUrl').value;
            if (!selectedImageBase64) {
                showResponse({ error: '请先选择用户照片' });
                return;
            }
            const body = {
                user_id: document.getElementById('default-user_id').value,
                picture_url: selectedImageBase64,
                body_profile: {
                    gender: document.getElementById('default-gender').value,
                    height: parseFloat(document.getElementById('default-height').value),
                    weight: parseFloat(document.getElementById('default-weight').value),
                    age: parseInt(document.getElementById('default-age').value),
                    skin_color: document.getElementById('default-skin_color').value,
                    body_type: document.getElementById('default-body_type').value
                },
                size: document.getElementById('default-size').value
            };
            try {
                const res = await fetch(`${baseUrl}/models/default`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) {
                showResponse({ error: e.message });
            }
        }

        async function editModel() {
            const baseUrl = document.getElementById('baseUrl').value;
            const body = {
                user_id: document.getElementById('edit-user_id').value,
                base_model_task_id: document.getElementById('edit-task_id').value,
                edit_instructions: document.getElementById('edit-instructions').value,
                size: document.getElementById('edit-size').value
            };
            try {
                const res = await fetch(`${baseUrl}/models/edit`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) {
                showResponse({ error: e.message });
            }
        }

        async function createOutfit() {
            const baseUrl = document.getElementById('baseUrl').value;
            if (selectedOutfitImages.length === 0) {
                showResponse({ error: '请先选择服装图片' });
                return;
            }
            const body = {
                user_id: document.getElementById('outfit-user_id').value,
                base_model_task_id: document.getElementById('outfit-task_id').value,
                angle: document.getElementById('outfit-angle').value,
                outfit_images: selectedOutfitImages,
                size: document.getElementById('outfit-size').value
            };
            try {
                const res = await fetch(`${baseUrl}/models/outfit`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(body)
                });
                showResponse(await res.json());
            } catch (e) {
                showResponse({ error: e.message });
            }
        }

        async function queryTask() {
            const baseUrl = document.getElementById('baseUrl').value;
            const taskId = document.getElementById('query-task_id').value;
            if (!taskId) {
                showResponse({ error: '请输入 task_id' });
                return;
            }
            try {
                const res = await fetch(`${baseUrl}/tasks/${taskId}`, {
                    headers: getHeaders()
                });
                showResponse(await res.json());
            } catch (e) {
                showResponse({ error: e.message });
            }
        }

        // 轮询相关
        let pollingInterval = null;

        function startPolling() {
            const taskId = document.getElementById('query-task_id').value;
            if (!taskId) {
                showResponse({ error: '请输入 task_id' });
                return;
            }

            document.getElementById('poll-btn').classList.add('hidden');
            document.getElementById('stop-poll-btn').classList.remove('hidden');
            document.getElementById('poll-status').classList.remove('hidden');
            document.getElementById('poll-status').textContent = '轮询中...';

            queryTask();

            pollingInterval = setInterval(async () => {
                const baseUrl = document.getElementById('baseUrl').value;
                const taskId = document.getElementById('query-task_id').value;
                try {
                    const res = await fetch(`${baseUrl}/tasks/${taskId}`, {
                        headers: getHeaders()
                    });
                    const data = await res.json();
                    showResponse(data);

                    const status = data.data?.status;
                    if (status === 'completed' || status === 'failed') {
                        stopPolling();
                        document.getElementById('poll-status').textContent = `任务${status === 'completed' ? '完成' : '失败'}，已停止轮询`;
                    }
                } catch (e) {
                    showResponse({ error: e.message });
                }
            }, 2000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            document.getElementById('poll-btn').classList.remove('hidden');
            document.getElementById('stop-poll-btn').classList.add('hidden');
            document.getElementById('poll-status').textContent = '轮询已停止';
        }
    </script>
</body>
</html>
